pipeline {
  agent {
    kubernetes {
      // Each build gets clean environment
      yamlFile './jenkinsfiles/agents/k8s_templates/docker_maven_pod.yaml' // Fetched from SCM Git repo
    }
  }

  // triggers {
  //   pollSCM 'H/5 * * * *'
  // }

  options {
    // disableConcurrentBuilds()
    buildDiscarder(logRotator(daysToKeepStr: '30', artifactDaysToKeepStr: '1'))
    timestamps()
    timeout(time: 5, unit: 'MINUTES')
  }

  environment {
    PROJECT_DIR = "${WORKSPACE}"
    MAVEN_PROJECT = "${PROJECT_DIR}/maven_project"
    PACKAGE_NAME = 'maven_project'
    // Write settings.xml directly to Jenkins workspace
    MAVEN_SETTINGS_XML = "${PROJECT_DIR}/settings.xml"
    IMAGE_NAME = 'cv47522/my-java-app'
    IMAGE_TAG = "${BUILD_NUMBER}"
  }

  parameters {
    booleanParam(
      name: 'CHECKOUT_REPO',
      defaultValue: false,
      description: 'Enable extra stage to checkout repo if not using "Pipeline script from SCM" config'
    )
    string(
      name: 'DOCKER_REGISTRY',
      defaultValue: 'docker.io',
      description: 'Specify the docker registry to pull images'
    )
  }

  stages {
    // stage('Declarative: Checkout SCM') { // Already added by "Pipeline script from SCM"
    //   steps {
    //     checkout scm
    //   }
    // }

    stage('Manual Repo Checkout') { // Or use "Pipeline script from SCM"
      when { expression { params.CHECKOUT_REPO } }
      steps {
        // Install Git in runtime or in agent Dockerfile
        checkout([
          $class: 'GitSCM',
          branches: [[ name: '*/master' ]],
          // branches: [[name: "FETCH_HEAD"]],
          userRemoteConfigs: [[
            url: 'https://github.com/cv47522/jenkins-101.git',
            // credentialsId: 'my-github'
          ]]
        ])

        // Or git clone only recent 5 commits:
        // sh '''
        //   git init .
        //   git pull --depth=5 https://github.com/cv47522/jenkins-101.git master
        // '''
      }
    }

    stage('Configure Maven Proxy') {
      steps {
        container('maven') {
          writeFile file: MAVEN_SETTINGS_XML, text: """
<?xml version="1.0" encoding="UTF-8"?>
<settings xmlns="http://maven.apache.org/SETTINGS/1.0.0"
          xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
          xsi:schemaLocation="http://maven.apache.org/SETTINGS/1.0.0
                              http://maven.apache.org/xsd/settings-1.0.0.xsd">
  <proxies>
    <proxy>
      <id>https-proxy</id>
      <active>true</active>
      <protocol>https</protocol>
      <host>${env.PROXY_IP}</host>
      <port>${env.PROXY_PORT}</port>
      <nonProxyHosts>127.0.0.1|localhost|*.svc|*.cluster.local|10.*</nonProxyHosts>
    </proxy>
    <proxy>
      <id>http-proxy</id>
      <active>true</active>
      <protocol>http</protocol>
      <host>${env.PROXY_IP}</host>
      <port>${env.PROXY_PORT}</port>
      <nonProxyHosts>127.0.0.1|localhost|*.svc|*.cluster.local|10.*</nonProxyHosts>
    </proxy>
  </proxies>
</settings>
""".trim()

          // Verify settings are applied
          sh """
            echo "‚úÖ Settings written successfully!"
            echo "üë§ Running as user: \$(id)"

            echo "üîç Testing Maven proxy:"
            mvn help:effective-settings -s ${MAVEN_SETTINGS_XML} | head -20
          """
        }
      }
    }

    stage('Get Package Version') {
      steps {
        script {
          dir(MAVEN_PROJECT) {
            // Read and parse pom.xml
            def pom = readMavenPom file: 'pom.xml'
            String packageVersion = pom.version
            echo "Resolved ${PACKAGE_NAME} Maven Package Version: ${packageVersion}"
            currentBuild.displayName = "${PACKAGE_NAME}-${packageVersion}/${BUILD_NUMBER}"
          }
        }
      }
    }

    // One-time logins for the whole build
    stage('Registry Login (once)') {
      steps {
        container('docker-client') {
          sh '''
            set -euo pipefail
            echo "‚è≥ Waiting for Docker daemon..."
            for i in \$(seq 1 60); do
              docker info >/dev/null 2>&1 && break
              sleep 1
            done
            docker info >/dev/null 2>&1 || { echo "‚ùå dockerd not ready"; exit 1; }
          '''
          // Login and push to DockerHub
          withCredentials([
            usernamePassword(credentialsId: 'docker-company-credentials',
              usernameVariable: 'INT_USER', passwordVariable: 'INT_PASS'),
            usernamePassword(credentialsId: 'dockerhub-credentials',
              usernameVariable: 'HUB_USER', passwordVariable: 'HUB_PASS')
          ]) {
            // NOTE: single-quoted Groovy string => no interpolation leakage
            // The same /root/.docker/config.json is reused by all CLI calls in the pod.
            sh """
              echo "üîê Login -> internal registry..."
              echo "${INT_PASS}" | docker login "${params.DOCKER_REGISTRY}" -u "${INT_USER}" --password-stdin
              echo "üîê Login -> Docker Hub..."
              # echo "${HUB_PASS}" | docker login -u "${HUB_USER}" --password-stdin
            """
          }
        }
      }
    }

    stage('Build & Test & Package Application') {
      steps {
        container('maven') {
          dir(MAVEN_PROJECT) {
            sh """
              echo 'üèóÔ∏è Building with proxy and cached dependencies...'
              java -version
              javac -version

              mvn clean package -s ${MAVEN_SETTINGS_XML}
              ls -la target/
            """
          }
        }
      }
    }

    stage('Build Docker Image') {
      steps {
        container('docker-client') {
          dir(MAVEN_PROJECT) {
            sh """
              docker build -t ${IMAGE_NAME}:${IMAGE_TAG} .
              docker tag ${IMAGE_NAME}:${IMAGE_TAG} ${IMAGE_NAME}:latest
              docker images | grep ${IMAGE_NAME}
            """
          }
        }
      }
    }

    stage('Push to DockerHub') {
      steps {
        script {
          container('docker-client') {
            sh """
              docker push ${IMAGE_NAME}:${IMAGE_TAG}
              docker push ${IMAGE_NAME}:latest
              docker logout
            """
          }
        }
      }
    }
  }

  post {
    always {
      dir(MAVEN_PROJECT) {
        // `fingerprint: true`: Computes & Stores artifact checksums to track/audit exactly which binary was built and where it goes
        archiveArtifacts artifacts: 'target/*.jar, pom.xml', fingerprint: true
      }
      // container('docker-client') {
      //   // (Optioanl, images already removed after each Pod dies in each build) Cleanup local images to save space
      //   sh """
      //     docker rmi ${IMAGE_NAME}:${IMAGE_TAG} || true
      //     docker rmi ${IMAGE_NAME}:latest || true
      //     docker system prune -f
      //   """
      // }
      cleanWs()
    }
    success {
      echo "‚úÖ Successfully built and pushed ${IMAGE_NAME}:${IMAGE_TAG}"
    }
    failure {
      echo "‚ùå Pipeline failed. Check logs for details."
    }
  }
}